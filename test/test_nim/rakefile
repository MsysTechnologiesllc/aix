require 'fileutils'

task :default => [ :copy_recipes, :install_fake, :run_nim, :deinstall_fake ]

task :toto => [ :copy_recipes, :install_fake, :run_toto, :deinstall_fake ]

task :hello  do
  puts 'Running RAKE for AIX CHEF'
end

# %n returns the file name without the extension and directory portions !
test_nim_list = FileList.new('../test_nim/recipes/*.rb').pathmap("%n")

##########################################################
## Variable definition
##########################################################

LOG_DIR = Time.new.strftime("%F_%H%M%S")
COOKBOOK_DIR = Dir.pwd + '/../../..'

##########################################################
## Function definition
##########################################################

desc 'Build client.rb file which is used to specify the configuration details for the chef-client.'
def build_config_file(config)
  ## Create LOGS Directory
  FileUtils.mkdir_p(Dir.pwd + '/LOGS/log_' + LOG_DIR )
  ## Fill in client.rb
  File.open("client.rb", "w") do |file|
    file.puts 'cookbook_path "' + Dir.pwd + '/../../.."'
    file.puts 'log_level :info'
    file.puts 'log_location "' + Dir.pwd + '/LOGS/log_' + LOG_DIR + '/'+ config.to_s + '.log"'
    file.puts 'verbose_logging true'
  end
  return 'client.rb'
end

##########################################################
## Task definition
##########################################################

desc 'Copy Test recipes to Cookbook recipes'
task :copy_recipes do
  FileUtils.cp_r Dir.pwd + '/recipes/.', COOKBOOK_DIR + '/aix/recipes', :verbose => true
end

desc 'Set up fake nim & suma'
task :install_fake do
  FileUtils.cp '/usr/sbin/nim', '/usr/sbin/nim.old', :verbose => true
  FileUtils.cp Dir.pwd + '/../aix_fake/nim', '/usr/sbin/nim', :verbose => true
  FileUtils.cp '/usr/sbin/suma', '/usr/sbin/suma.old', :verbose => true
  FileUtils.cp Dir.pwd + '/../aix_fake/suma', '/usr/sbin/suma', :verbose => true
end

desc 'Remove fake from machine'
task :deinstall_fake do
  FileUtils.cp '/usr/sbin/nim.old', '/usr/sbin/nim', :verbose => true
  FileUtils.cp '/usr/sbin/suma.old', '/usr/sbin/suma', :verbose => true
end

task :run_toto do
  build_config_file('test_nim_sync_mono_latest_sp')
  puts '----------------------' + '-' * 'test_nim_sync_mono_latest_sp'.length + '------'
  puts '----- Running recipe: ' + 'test_nim_sync_mono_latest_sp' + ' -----'
  puts '----------------------' + '-' * 'test_nim_sync_mono_latest_sp'.length + '------'
  sh 'chef-client --local-mode -c client.rb --runlist "recipe[aix::' + 'test_nim_sync_mono_latest_sp' + ']" || true'
end

desc 'Run all NIM tests'
task :run_nim do
  puts '/////////////////////////////////////////////////////////////////////'
  puts '                    Running NIM tests'
  puts '/////////////////////////////////////////////////////////////////////'
  test_nim_list.each do |fl|
    build_config_file(fl)
    puts '----------------------' + '-' * fl.length + '------'
    puts '----- Running recipe: ' + fl + ' -----'
    puts '----------------------' + '-' * fl.length + '------'
    sh 'chef-client --local-mode -c client.rb --runlist "recipe[aix::' + fl + ']" || true'
  end
end
